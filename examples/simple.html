<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <title>Sankey Javascript Demo: Spread effort 2050 Pathway</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="../ext/raphael.js" type="text/javascript"></script>
    <script src="../ext/jquery.js" type="text/javascript"></script>
    <script src="../js/sankey.js" type="text/javascript"></script>
				<link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <script type='text/javascript'>
    //var small_some_data = d3.json("https://github.com/Epieros/Sankey/blob/master/data/sample_data_adj.json");
		var some_data = [
			{"computer_name":"Computer.1","scan_date":"2016-09-17","malwares_found":21,"malwares_quarantined":1},
			{"computer_name":"Computer.2","scan_date":"2016-09-17","error_code":"SCAN_ERROR"},
			{"computer_name":"Computer.3","scan_date":"2016-09-18","malwares_found":0,"malwares_quarantined":0},
			{"computer_name":"Computer.4","scan_date":"2016-09-18","malwares_found":3,"malwares_quarantined":1},
			{"computer_name":"Computer.5","scan_date":"2016-09-19","error_code":"SCAN_ERROR"},
			{"computer_name":"Computer.6","scan_date":"2016-09-19","error_code":"SCAN_ERROR"},
			{"computer_name":"Computer.7","scan_date":"2016-09-17","malwares_found":0,"malwares_quarantined":0},
			{"computer_name":"Computer.8","scan_date":"2016-09-17","malwares_found":14,"malwares_quarantined":9},
			{"computer_name":"Computer.9","scan_date":"2016-09-17","error_code":"SCAN_ERROR"},
			{"computer_name":"Computer.10","scan_date":"2016-09-17","malwares_found":3,"malwares_quarantined":3},
			{"computer_name":"Computer.12","scan_date":"2016-09-17","malwares_found":26,"malwares_quarantined":14},
			{"computer_name":"Computer.9","scan_date":"2016-09-18","error_code":"SCAN_ERROR"},
			{"computer_name":"Computer.10","scan_date":"2016-09-18","malwares_found":3,"malwares_quarantined":3},
			{"computer_name":"Computer.11","scan_date":"2016-09-18","malwares_found":26,"malwares_quarantined":14},
			{"computer_name":"Computer.10","scan_date":"2016-09-20","malwares_found":3,"malwares_quarantined":3},
			{"computer_name":"Computer.12","scan_date":"2016-09-20","malwares_found":26,"malwares_quarantined":26},
			{"computer_name":"Computer.2","scan_date":"2016-09-21","malwares_found":0,"malwares_quarantined":0},
			{"computer_name":"Computer.3","scan_date":"2016-09-21","malwares_found":0,"malwares_quarantined":0}
		];

		var label_set = ["Compromised","Cleaned","Failed","Disconnected","Clean"]
		var date_set = set_dates(some_data);
		var name_set = set_names(some_data);
		var tranistion_set = set_state(some_data, date_set, name_set);

		//console.log(date_set);
		//console.log(name_set);
		//console.log(state_set);
		//console.log(tranistion_set);

		// set of unique dates in data set
		function set_dates(data_set) {
			var result_dates = [], prev;
			var dateLen = data_set.length;
			data_set.sort(function (a,b){
				return new Date(a.scan_date) - new Date(b.scan_date);
			});
			for (i = 0; i < dateLen; i++) {
				if (data_set[i].scan_date != prev) {
					result_dates.push(data_set[i].scan_date);
				}
			prev = data_set[i].scan_date;
			}
			return result_dates
		};

		// set of unique computer names in data set
		function set_names(data_set) {
			var result_names = [], prev;
			var nameLen = data_set.length;
			data_set.sort(function (a,b){
				if(a.computer_name < b.computer_name) return -1;
				if(a.computer_name > b.computer_name) return 1;
				return 0;
			});
			for (i = 0; i < nameLen; i++) {
				if (data_set[i].computer_name != prev) {
					result_names.push(data_set[i].computer_name);
				}
				prev = data_set[i].computer_name;
			}
			return result_names
		};

		// set the state for each computer_name in name_set, for each scan_date in date_set.
		// states will be used to populate the sankey.stack and sankey.setData
		function set_state(data_set, dates, names) {
			var result_states = [];
			var transitions = [];
			var sumTransitions = [];
			var dateLen = dates.length;
			var nameLen = names.length;
			var index = 0;
			var state = "";
			var prev_state = "";
			var curr_state = "";
			var prev_index = 0;
			var curr_index = 0;
			for (i = 0; i < dateLen; i++) {
				for (j = 0; j < nameLen; j++) {
					index = data_set.findIndex(function (element){
						return element.scan_date === dates[i] && element.computer_name === names[j];
					});
					if (index >= 0) {
						if (data_set[index].malwares_found == 0) {state = "Clean"}
           					if (data_set[index].malwares_found != 0 &&
							data_set[index].malwares_found == data_set[index].malwares_quarantined) {state = "Cleaned"}
						if (data_set[index].malwares_found > data_set[index].malwares_quarantined) {state = "Compromised"}
						if (data_set[index].error_code == "SCAN_ERROR") {state = "Failed"}
						result_states.push({scan_date:dates[i],
								computer_name:names[j],
								scan_state: state,
								malwares_found: data_set[index].malwares_found,
								malwares_quarantined: data_set[index].malwares_quarantined
						});
					} //end of if index >= 0
					else {
						state = "Disconnected";
						result_states.push({scan_date:dates[i],
								computer_name:names[j],
								scan_state: state,
								malwares_found: undefined,
								malwares_quarantined: undefined
						});
					} //end else

					if (i > 0) {
						prev_index = result_states.findIndex(function (element){
							return element.scan_date === dates[i-1] && element.computer_name === names[j];
						});
						curr_index = result_states.findIndex(function (element){
							return element.scan_date === dates[i] && element.computer_name === names[j];
						});
						prev_state = result_states[prev_index].scan_state+[i-1];
						curr_state = result_states[curr_index].scan_state+[i];
						transitions.push({prev_state: prev_state,
								computer_count: 1,
								curr_state: curr_state
								});
					}//end if i > 0
				} //end for j
			} //end for i
			//return result_states;
      			sumTransitions = count_transitions(transitions);
			var test = [];
      			for (k=0; k<sumTransitions.length; k++) {
				test.push([sumTransitions[k].key,sumTransitions[k].values[0].value.computer_count,sumTransitions[k].values[0].key]);
			}

			console.log(test);
			return test;
      		}; //end set_state function

		// summarize counts by state by day
		function count_transitions(data_set) {
			var sumData = d3.nest()
				.key(function(d) {return d.prev_state;})
				.key(function(d) {return d.curr_state;})
				.rollup(function(values) {return {"computer_count": d3.sum(values, function(d) {return +d.computer_count})}})
				.entries(data_set);
			return sumData;
		} //end count_states function


      $(document).ready(function() {
        var sankey = new Sankey();

        var labels;
        var dateLen = date_set.length;
        var labelLen = label_set.length;

        for (i=0; i<dateLen; i++) {
          labels = [];
          for (j=0; j<labelLen; j++) {
            labels[j] = label_set[j]+[i];
          } //end of for j
          sankey.stack([i],labels);
        } //end of for i


sankey.setData([
  tranistion_set[0],tranistion_set[1],tranistion_set[2],tranistion_set[3],tranistion_set[4],tranistion_set[5],tranistion_set[6],tranistion_set[7],tranistion_set[8],
  tranistion_set[9],tranistion_set[10],tranistion_set[11],tranistion_set[12],tranistion_set[13]
]);

/*
        sankey.setData([["Clean0",1,"Clean1"],["Clean0",2,"Cleaned1"],["Clean0",7,"Failed1"],["Clean0",8,"Compromised1"],["Clean0",8,"Disconnected1"],
                        ["Clean1",1,"Clean2"],["Clean1",2,"Cleaned2"],["Clean1",7,"Failed2"],["Clean1",8,"Compromised2"],["Clean1",8,"Disconnected2"],
                        ["Clean2",1,"Clean3"],["Clean2",2,"Cleaned3"],["Clean2",7,"Failed3"],["Clean2",8,"Compromised3"],["Clean2",8,"Disconnected3"],

                        ["Cleaned0",1,"Clean1"],["Cleaned0",2,"Cleaned1"],["Cleaned0",7,"Failed1"],["Cleaned0",8,"Compromised1"],["Cleaned0",8,"Disconnected1"],
                        ["Cleaned1",1,"Clean2"],["Cleaned1",2,"Cleaned2"],["Cleaned1",7,"Failed2"],["Cleaned1",8,"Compromised2"],["Cleaned1",8,"Disconnected2"],
                        ["Cleaned2",1,"Clean3"],["Cleaned2",2,"Cleaned3"],["Cleaned2",7,"Failed3"],["Cleaned2",8,"Compromised3"],["Cleaned2",8,"Disconnected3"],

                        ["Failed0",1,"Clean1"],["Failed0",2,"Cleaned1"],["Failed0",7,"Failed1"],["Failed0",8,"Compromised1"],["Failed0",8,"Disconnected1"],
                        ["Failed1",1,"Clean2"],["Failed1",2,"Cleaned2"],["Failed1",7,"Failed2"],["Failed1",8,"Compromised2"],["Failed1",8,"Disconnected2"],
                        ["Failed2",1,"Clean3"],["Failed2",2,"Cleaned3"],["Failed2",7,"Failed3"],["Failed2",8,"Compromised3"],["Failed2",8,"Disconnected3"],

                        ["Compromised0",1,"Clean1"],["Compromised0",2,"Cleaned1"],["Compromised0",7,"Failed1"],["Compromised0",8,"Compromised1"],["Compromised0",8,"Disconnected1"],
                        ["Compromised1",1,"Clean2"],["Compromised1",2,"Cleaned2"],["Compromised1",7,"Failed2"],["Compromised1",8,"Compromised2"],["Compromised1",8,"Disconnected2"],
                        ["Compromised2",1,"Clean3"],["Compromised2",2,"Cleaned3"],["Compromised2",7,"Failed3"],["Compromised2",8,"Compromised3"],["Compromised2",8,"Disconnected3"],

                        ["Disconnected0",1,"Clean1"],["Disconnected0",2,"Cleaned1"],["Disconnected0",7,"Failed1"],["Disconnected0",8,"Compromised1"],["Disconnected0",8,"Disconnected1"],
                        ["Disconnected1",1,"Clean2"],["Disconnected1",2,"Cleaned2"],["Disconnected1",7,"Failed2"],["Disconnected1",8,"Compromised2"],["Disconnected1",8,"Disconnected2"],
                        ["Disconnected2",1,"Clean3"],["Disconnected2",2,"Cleaned3"],["Disconnected2",7,"Failed3"],["Disconnected2",8,"Compromised3"],["Disconnected2",8,"Disconnected3"],
          ]);
*/
        sankey.draw();
    });

    </script>
    <h1 style='width:1000px; text-align: center; margin-bottom: 0'>A very simple Sankey Diagram</h1>
    <div style='width:1000px; text-align: center; margin-top: 0'>Move your mouse over the diagram to show values</div>
    <div id='sankey' style="width:1000px;height:1000px">
      &nbsp;
    </div>
  </body>
</html>
